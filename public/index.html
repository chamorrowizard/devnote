<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Shared Elements App (Firebase)</title>
<style>
    * { box-sizing: border-box; }
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #c3d5ff, #ffe3f5);
        padding: 20px;
    }

    .container {
        max-width: 600px;
        margin: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .element-card {
        background: rgba(255,255,255,0.35);
        backdrop-filter: blur(12px);
        padding: 14px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* Indentation for different levels (up to 5) */
    .element-level-1 { margin-left: 0px; }
    .element-level-2 { margin-left: 10px; }
    .element-level-3 { margin-left: 20px; }
    .element-level-4 { margin-left: 30px; }
    .element-level-5 { margin-left: 40px; }

    .element-header {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer; /* Makes entire header clickable */
    }

    .element-title-input {
        font-size: 1.1rem;
        font-weight: bold;
        border: none;
        background: none;
        padding: 0;
        margin: 0;
        /* Mobile Fixes */
        min-width: 0;
        overflow: hidden; 
        text-overflow: ellipsis;
        white-space: nowrap;
        flex-grow: 1;
        cursor: text; /* Allow text cursor when editing title */
    }

    .arrow-btn, .add-btn {
        font-size: 1rem;
        padding: 4px 10px;
        border: none;
        border-radius: 8px;
        background: rgba(255,255,255,0.45);
        cursor: pointer;
        backdrop-filter: blur(4px);
        white-space: nowrap;
    }
    
    .add-btn {
        background: rgba(0,123,255,0.4);
        color: white;
        font-weight: bold;
    }

    .delete-btn {
        background: rgba(255,0,0,0.4);
        backdrop-filter: blur(6px);
        border: none;
        color: white;
        font-weight: bold;
        padding: 6px 10px;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.2s ease;
    }
    .delete-btn:hover { background: rgba(255,0,0,0.7); }

    .details {
        padding-top: 6px;
        padding-left: 8px;
        font-size: 0.9rem;
    }

    /* Hide details when element is collapsed via data-attribute */
    .element-card[data-expanded="false"] .details {
        display: none;
    }

    .details textarea {
        width: 100%;
        min-height: 80px;
        border-radius: 8px;
        border: 1px solid rgba(0,0,0,0.1);
        padding: 8px;
        font-size: 0.9rem;
        resize: vertical;
        background: rgba(255,255,255,0.5);
    }
    
    .details-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        justify-content: flex-end;
    }

    .notes-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 420px;
        background: rgba(255,255,255,0.5);
        backdrop-filter: blur(14px);
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 8px 40px rgba(0,0,0,0.2);
        display: none;
        flex-direction: column;
        gap: 14px;
        z-index: 999;
    }

    .notes-modal textarea {
        width: 100%;
        min-height: 150px;
        border-radius: 10px;
        border: none;
        padding: 12px;
        font-size: 1rem;
        resize: vertical;
    }

    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .modal-btn {
        padding: 8px 14px;
        background: rgba(255,255,255,0.4);
        border: none;
        border-radius: 12px;
        cursor: pointer;
        backdrop-filter: blur(4px);
    }
</style>

<script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script> 

</head>
<body>
<div class="container" id="container"></div>

<div class="notes-modal" id="notesModal">
    <h3>Notes</h3>
    <textarea id="notesInput"></textarea>
    <div class="modal-buttons">
        <button class="modal-btn" id="closeNotes">Close</button>
        <button class="modal-btn" id="saveNotes">Save</button>
    </div>
</div>

<script>
// --- START FIREBASE CONFIGURATION ---

// 1. >>> REPLACE THIS OBJECT with your actual Firebase project config <<<
// (I am using the config shown in your shared page for demonstration)
const firebaseConfig = {
    apiKey: "AIzaSyAKoits_cPxjxKOK5lRYyiyGj2j9MNeXvs",
    authDomain: "devnote-b160f.firebaseapp.com",
    databaseURL: "https://devnote-b160f-default-rtdb.firebaseio.com",
    projectId: "devnote-b160f",
    storageBucket: "devnote-b160f.firebasestorage.app",
    messagingSenderId: "802566652506",
    appId: "1:802566652506:web:b51d671a15c2f749ac0e63",
    measurementId: "G-7JK24N4T2R"
};

// 2. >>> Get the BASE URL of your hosted site (e.g., https://devnote-b160f.web.app/) <<<
// We use window.location.origin to handle the current protocol and domain dynamically.
const BASE_URL = window.location.origin + window.location.pathname; 


// 3. Initialize Firebase and get database reference
const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();
let elementsRef; // This will be defined dynamically later
let currentProjectId; // Holds the ID of the current project

// --- END FIREBASE CONFIGURATION ---


// --- Data and Utilities (Updated to handle dynamic project paths) ---

let elements = [];
let activeNoteId = null;

function generateUniqueId() {
    // Generate a unique, short, human-readable ID for the project link
    return Math.random().toString(36).substring(2, 9);
}

function saveElementsToFirebase() {
    if (elementsRef) {
        elementsRef.set(elements)
            .catch((error) => {
                console.error("Data save failed: ", error);
            });
    }
}

// ... (Other utility functions like getChildren, getElementLevel, deleteRecursively, areAllAncestorsExpanded remain UNCHANGED)

// --- Rendering Logic (Updated to show current project ID) ---

function createElementCard(el) {
    // ... (This function remains UNCHANGED)
    // You can copy the body of the createElementCard function from the previous complete script.
    // ...
    const level = getElementLevel(el.id);
    
    const card = document.createElement("div");
    card.className = `element-card element-level-${level}`;
    card.dataset.id = el.id;
    card.dataset.parentid = el.parentId || "null";
    card.dataset.expanded = el.expanded;
    card.style.display = 'flex'; 

    const header = document.createElement('div');
    header.className = 'element-header';
    header.dataset.action = "toggle-children-header";
    header.dataset.id = el.id;
    
    header.innerHTML = `
        <button class="add-btn" data-add-child="${el.id}" ${level >= 5 ? 'disabled' : ''}>+ Child</button>
        <input class="element-title-input" value="${el.title}" data-title-id="${el.id}" placeholder="Element Title">
    `;
    card.appendChild(header);

    const details = document.createElement('div');
    details.className = 'details';
    details.id = `details-${el.id}`;
    
    details.innerHTML = `
        <textarea data-details-id="${el.id}" placeholder="Enter details here">${el.details}</textarea>
        
        <div class="details-buttons">
            <button class="arrow-btn" data-notes="${el.id}">Notes</button>
            <button class="arrow-btn" data-id="${el.id}" data-action="toggle-children">${el.expanded ? 'â–²' : 'â–¼'}</button>
            <button class="delete-btn" data-delete="${el.id}">âœ•</button>
        </div>
    `;
    card.appendChild(details);

    return card;
}

function setDescendantVisibility(parentId, visible) {
    // ... (This function remains UNCHANGED)
    const descendants = elements.filter(el => {
        let current = el;
        while (current) {
            if (current.parentId === parentId) return true;
            current = elements.find(e => e.id === current.parentId);
        }
        return false;
    });

    descendants.forEach(el => {
        const card = document.querySelector(`.element-card[data-id="${el.id}"]`);
        if (card) {
            if (areAllAncestorsExpanded(el.parentId)) {
                card.style.display = 'flex';
                card.dataset.expanded = el.expanded; 
            } else {
                card.style.display = 'none';
            }
        }
    });
}


function render() {
    const container = document.getElementById("container");
    container.innerHTML = "";
    
    // Display the current project ID
    const projectHeader = document.createElement("h3");
    projectHeader.textContent = `Project: ${currentProjectId || 'Loading...'}`;
    projectHeader.style.textAlign = 'center';
    projectHeader.style.color = '#333';
    container.appendChild(projectHeader);

    // --- New Top Bar for Add and Copy Link Buttons ---
    const topBar = document.createElement("div");
    topBar.style.display = 'flex';
    topBar.style.justifyContent = 'space-between';
    topBar.style.marginBottom = '12px';
    container.appendChild(topBar);

    // Add the global Add button for top-level elements
    const addButton = document.createElement("button");
    addButton.className = "add-btn";
    addButton.textContent = "+ Add New Top-Level Element";
    addButton.id = "addNewElement";
    topBar.appendChild(addButton);
    
    // NEW: Generate New Project Button
    const newProjectButton = document.createElement("button");
    newProjectButton.className = "arrow-btn";
    newProjectButton.textContent = "âœ¨ New Project Link";
    newProjectButton.id = "newProjectLink";
    topBar.appendChild(newProjectButton);

    // NEW: Copy Current Project Link
    const copyButton = document.createElement("button");
    copyButton.className = "arrow-btn";
    copyButton.textContent = "ðŸ”— Copy Current Link";
    copyButton.id = "copyLinkButton";
    topBar.appendChild(copyButton);
    // ----------------------------------------------------

    const cardMap = new Map();
    elements.forEach(el => {
        const card = createElementCard(el);
        cardMap.set(el.id, card);
    });

    elements.forEach(el => {
        container.appendChild(cardMap.get(el.id));
    });

    elements.forEach(el => {
        const card = cardMap.get(el.id);
        if (el.parentId && !areAllAncestorsExpanded(el.parentId)) {
            card.style.display = 'none';
        }
    });
}

// --- Core Toggle Function (Remains UNCHANGED) ---
function toggleElement(id) {
    const el = elements.find(x => x.id === id);
    if (el) {
        el.expanded = !el.expanded;
        // Find the arrow button and update its text
        const arrowButton = document.querySelector(`.details-buttons button[data-id="${id}"][data-action="toggle-children"]`);
        if (arrowButton) {
            arrowButton.textContent = el.expanded ? 'â–²' : 'â–¼';
        }

        const card = document.querySelector(`.element-card[data-id="${id}"]`);
        if (card) {
            card.dataset.expanded = el.expanded;
        }

        setDescendantVisibility(id, el.expanded);
        saveElementsToFirebase(); 
    }
}


// --- Firebase Logic to Handle Project ID in URL ---

function getQueryParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

function startRealtimeSync() {
    let projectId = getQueryParameter('projectId');

    if (!projectId) {
        projectId = generateUniqueId();
        window.location.search = `?projectId=${projectId}`;
        return; 
    }

    currentProjectId = projectId;
    elementsRef = database.ref(`projects/${projectId}/elements`);

    elementsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        
        if (data) {
            // Data exists, load it
            if (Array.isArray(data)) {
                elements = data;
            } else if (typeof data === 'object' && data !== null) {
                elements = Object.keys(data).map(key => data[key]);
            }
            render();
            
        } else {
            // Data is empty, so initialize the array
            // Check if our local array is ALSO empty before initializing
            if (elements.length === 0) { 
                elements = [
                    { id: "1", title: `Project ${projectId}`, details: "Start collaborating here!", notes: "", parentId: null, expanded: true },
                ];
                // *** NEW LINE: SAVE IT TO FIREBASE ONLY ONCE IF IT'S BRAND NEW ***
                saveElementsToFirebase(); 
            }
            render(); 
        }
        
    }, (error) => {
        console.error("Firebase read failed: " + error.code);
    });
}

// --- Event Listeners (Updated for the new link button) ---

document.addEventListener("click", e => {
    
    // ... (toggle, delete, add element logic remains UNCHANGED)

    // Toggle Children (from the specific arrow button)
    if (e.target.dataset.action === "toggle-children") {
        const id = e.target.dataset.id;
        toggleElement(id);
    }
    
    // Toggle Children (from the element header click)
    const header = e.target.closest('.element-header');
    if (header && header.dataset.action === "toggle-children-header" && e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
        const id = header.dataset.id;
        toggleElement(id);
    }

    // Delete
    if (e.target.dataset.delete) {
        const id = e.target.dataset.delete;
        const elToDelete = elements.find(x => x.id === id);
        if (elToDelete && confirm(`Delete "${elToDelete.title}" and ALL its children?`)) {
            deleteRecursively(id);
            saveElementsToFirebase();
        }
    }

    // Add New Element (Global button)
    if (e.target.id === "addNewElement") {
        const newElement = {
            id: generateUniqueId(),
            title: "New Top-Level Element",
            details: "Editable content here.",
            notes: "",
            parentId: null,
            expanded: true
        };
        elements.push(newElement);
        saveElementsToFirebase();
    }
    
    // Add Child Element 
    if (e.target.dataset.addChild) {
        const parentId = e.target.dataset.addChild;
        const parentElement = elements.find(el => el.id === parentId);
        const level = getElementLevel(parentId);

        if (level < 5 && parentElement) {
            const newElement = {
                id: generateUniqueId(),
                title: `Child of ${parentElement.title}`,
                details: "Editable child content.",
                notes: "",
                parentId: parentId,
                expanded: true 
            };
            
            // Simplified insertion logic
            const parentIndex = elements.findIndex(el => el.id === parentId);
            let lastDescendantIndex = parentIndex;

            for (let i = parentIndex + 1; i < elements.length; i++) {
                let current = elements[i];
                let checkParent = current;
                let isDescendant = false;
                
                while (checkParent) {
                    if (checkParent.parentId === parentId) {
                        isDescendant = true;
                        break;
                    }
                    checkParent = elements.find(e => e.id === checkParent.parentId);
                }

                if (isDescendant) {
                    lastDescendantIndex = i;
                } else if (current.parentId === null || getElementLevel(current.id) <= level) {
                    break;
                }
            }

            elements.splice(lastDescendantIndex + 1, 0, newElement);
            
            if (!parentElement.expanded) {
                parentElement.expanded = true;
            }

            saveElementsToFirebase();
        }
    }


    // NEW: Generate New Project Link Handler
    if (e.target.id === "newProjectLink") {
        const newId = generateUniqueId();
        const newUrl = `${BASE_URL}?projectId=${newId}`;
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(newUrl).then(() => {
                e.target.textContent = "âœ… Link Copied!";
                setTimeout(() => {
                    e.target.textContent = "âœ¨ New Project Link";
                }, 1500);
            });
        }
        // Redirect the current user to the new project
        window.location.href = newUrl;
    }


    // UPDATED: Copy Current Link Handler
    if (e.target.id === "copyLinkButton") {
        const currentUrl = window.location.href;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(currentUrl).then(() => {
                e.target.textContent = "âœ… Link Copied!";
                setTimeout(() => {
                    e.target.textContent = "ðŸ”— Copy Current Link";
                }, 1500);
            }).catch(err => {
                console.error('Could not copy text: ', err);
                alert('Could not copy link. Please manually copy this URL: ' + currentUrl);
            });
        } else {
             alert('Clipboard access denied or URL not set. Please manually copy this URL: ' + currentUrl);
        }
    }


    // ... (notes modal handlers remain UNCHANGED)

    // Notes
    if (e.target.dataset.notes) {
        activeNoteId = e.target.dataset.notes;
        const el = elements.find(x => x.id === activeNoteId);
        document.getElementById("notesInput").value = el.notes || "";
        document.getElementById("notesModal").style.display = "flex";
    }
    
    // Notes Modal Save
    if (e.target.id === "saveNotes") {
        const el = elements.find(x => x.id === activeNoteId);
        el.notes = document.getElementById("notesInput").value;
        saveElementsToFirebase();
        document.getElementById("notesModal").style.display = "none";
    }
    
    // Notes Modal Close
    if (e.target.id === "closeNotes") {
        document.getElementById("notesModal").style.display = "none";
    }

});

// Handle input changes for title and details
document.addEventListener("input", e => {
    // Title change
    if (e.target.dataset.titleId) {
        const id = e.target.dataset.titleId;
        const el = elements.find(x => x.id === id);
        el.title = e.target.value;
        saveElementsToFirebase();
    }
    // Details change
    if (e.target.dataset.detailsId) {
        const id = e.target.dataset.detailsId;
        const el = elements.find(x => x.id === id);
        el.details = e.target.value;
        saveElementsToFirebase();
    }
});

// Prevent header click from triggering if the input field is clicked
document.addEventListener("mousedown", e => {
    if (e.target.tagName === 'INPUT' && e.target.dataset.titleId) {
        e.stopPropagation(); 
    }
});


// Start the real-time synchronization once the script loads
startRealtimeSync();
</script>
</body>
</html>